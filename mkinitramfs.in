#!/bin/sh
# mkinitramfs - create an initial ramdisk environment
# See COPYING and COPYRIGHT files for corresponding information.

# https://www.shellcheck.net/wiki/SC2154
# shellcheck disable=2154

print() {
  printf "%b %s\n" "${2:-">>"}" "$1"
}

panic() {
  print "${1:-unexpected error occurred}" "\033[1;31m!!\033[m"

  exit 1
} >&2

print_help() {
  cat << EOF
Usage: mkinitramfs [OPTION]...
Create an initial ramdisk environment.

Mandatory arguments to long options are mandatory for short options too.
  -o, --output=FILE      set path to initramfs image
  -c, --config=FILE      set path to config
  -k, --kernel=VERSION   set kernel version
  -m, --modules=PATH     set path to modules
  -H, --hooks=PATH       set directory to hooks
  -D, --helper=FILE      set path to device helper
  -I, --init=FILE        set path to init script
  -d, --debug            enable debug mode
  -f, --force            overwrite initramfs image
  -v, --version          print version and exit
  -h, --help             print help and exit
EOF
}

print_version() {
  echo "mkinitramfs @VERSION@"
}

parse_options() {
  local _SOPTS="o:c:k:m:H:D:I:dfvh"
  local _LOPTS="output:,config:,kernel:,modules:,hooks:,helper:,init:,debug,force,version,help"

  eval set -- "$(getopt -n "mkinitramfs" -a -o "$_SOPTS" -l "$_LOPTS" -- "$@")"

  while true; do
    case $1 in
    -o| --output)  output="$2"   ; shift  ;;
    -c| --config)  config="$2"   ; shift  ;;
    -k| --kernel)  kernel="$2"   ; shift  ;;
    -m|--modules)  moddir="$2"   ; shift  ;;
    -H|  --hooks)  hksdir="$2"   ; shift  ;;
    -D| --helper)  helper="$2"   ; shift  ;;
    -I|   --init)  init="$2"     ; shift  ;;
    -d|  --debug)  debug="$1"             ;;
    -f|  --force)  force="$1"             ;;
    -v|--version)  print_version ; exit 0 ;;
    -h|   --help)  print_help    ; exit 0 ;;
              --)  shift         ; break  ;;
               *)  panic "internal error" ;;
    esac
    shift
  done

  # https://www.shellcheck.net/wiki/SC1090
  # shellcheck disable=1090
  . "${config:=/etc/mkinitramfs/config}"

  : "${kernel:=$(uname -r)}"
  : "${moddir:=/lib/modules}"
  : "${init:=/usr/share/mkinitramfs/init}"
  : "${helper:=/usr/share/mkinitramfs/device-helper}"
  : "${output:=${TMPDIR:-/tmp}/mkinitramfs-${kernel}}"

  mkdir -p "${tmpdir:=${TMPDIR:-/tmp}/mkinitramfs.$$}"

  # https://www.shellcheck.net/wiki/SC2015
  # shellcheck disable=2015
  [ "$debug" = 1 ] && set -x || trap 'rm -rf $tmpdir' EXIT INT
}

prepare_initramfs() {
  print "preparing initramfs"

  # https://wikipedia.org/wiki/Filesystem_Hierarchy_Standard
  mkdir -p                    \
    "$tmpdir/dev"             \
    "$tmpdir/sys"             \
    "$tmpdir/tmp"             \
    "$tmpdir/run"             \
    "$tmpdir/var"             \
    "$tmpdir/proc"            \
    "$tmpdir/root"            \
    "$tmpdir/usr/lib"         \
    "$tmpdir/usr/bin"         \
    "$tmpdir/mnt/root"        \
    "$tmpdir/etc/mkinitramfs"

  ln -s usr/lib      "$tmpdir/usr/lib64"
  ln -s usr/lib      "$tmpdir/lib64"
  ln -s usr/lib      "$tmpdir/lib"
  ln -s usr/bin      "$tmpdir/bin"
  ln -s usr/bin      "$tmpdir/sbin"
  ln -s ../run       "$tmpdir/var/run"
  ln -s ../run/lock  "$tmpdir/var/lock"
  ln -s bin          "$tmpdir/usr/sbin"

  for _bin in \
    \[ sh ln env mkdir sleep mount printf switch_root "$helper"
  do
    copy_binary "$_bin"
  done

  command -v blkid >/dev/null && copy_binary blkid

  copy_file "$init"   /init                   755 0
  copy_file "$config" /etc/mkinitramfs/config 644 0
}

copy_file() (
  _file="$1" _dest="$2" _mode="$3" _strip="$4"

  [ -e "$tmpdir/$_dest" ] && return 0

  mkdir -p "$tmpdir/${_dest%/*}" || panic

  # Iterate through symlinks and copy them.
  while [ -h "$_file" ]; do
    cp -P "$_file" "$tmpdir/${_dest%/*}/${_file##*/}"
    cd -P "${_file%/*}"

    _symlink=$(ls -ld "$_file")
    _symlink="${_symlink##* -> }"

    # TODO handle ../../..
    case "$_symlink" in
    /*) _file="$_symlink"            ;;
     *) _file="$PWD/${_symlink##*/}" ;;
    esac
  done

  # Handle case when _file and _dest have same basenames
  [ -h "$tmpdir/$_dest" ] && _dest="$_file"

  {
    cp    "$_file" "$tmpdir/$_dest"
    chmod "$_mode" "$tmpdir/$_dest"
  } || panic

  # https://www.shellcheck.net/wiki/SC2015
  # shellcheck disable=2015
  [ "$_strip" = 1 ] && strip "$tmpdir/$_dest" >/dev/null 2>&1 || :
)

copy_binary() {
  binary=$(command -v "$1")

  # If output is
  #
  # empty, do panic
  # external command, do nothing
  # builtin command, try to find external alternative.
  #
  # https://www.shellcheck.net/wiki/SC2086
  # shellcheck disable=2086
  case "$binary" in
  */*)
    ;;
  "")
    panic "$1 does not exist"
    ;;
  *)
    IFS=:; set -- $PATH; unset IFS

    _binary="$binary"

    for _dir; do
      binary="${_dir}/${_binary}"

      [ -x "$binary" ] && break
    done || panic "$_binary does not exist"
    ;;
  esac

  copy_file "$binary" "/bin/${binary##*/}" 755 1

  # Skip copying binary dependencies if ldd not available.
  command -v ldd >/dev/null || return 0

  # Copy binary dependencies if any exist.
  ldd "$binary" 2>/dev/null | while read -r _lib || [ "$_lib" ]; do
    _lib="${_lib#* => }"
    _lib="${_lib% *}"

    [ -e "$_lib" ] && copy_file "$_lib" "/lib/${_lib##*/}" 755 1
  done
}

copy_module() {
  # arg $1: module name
  modprobe -S "$kernel" -D "$1" 2>/dev/null |
    while read -r _typ _mod _param || [ "$_mod" ]; do
      #[ "$_typ" = "builtin" ] || copy_file "$_mod" "$_mod" 0644 0
      case $_mod in /*) copy_file "$_mod" "$_mod" 0644 0; esac
    done
}

copy_hook() {
  # arg $1: hook

  for _hookdir in "$hksdir" \
    /etc/mkinitramfs/hooks /usr/share/mkinitramfs/hooks
  do
      [ -f "$_hookdir/$1/$1" ] && break
  done || panic "could not find $1 hook"

  print "running $1 hook"

  # https://www.shellcheck.net/wiki/SC1090
  # shellcheck disable=1090
  . "$_hookdir/$1/$1"

  for _hooktyp in init init.late; do
    [ -f "$_hookdir/$1/$1.$_hooktyp" ] || continue

    print "copying $1.$_hooktyp"

    copy_file "$_hookdir/$1/$1.$_hooktyp" \
      "/usr/share/mkinitramfs/hooks/$1/$1.$_hooktyp" 644 0
  done
}

copy_modules() {
  # Skip this function if kernel compiled with builtin modules.
  if [ "$monolith" = 1 ]; then
    return 0

  elif [ "$hostonly" = 1 ]; then
    print "copying hostonly modules"

    # Perform autodetection of modules via /sys
    # https://wiki.archlinux.org/index.php/Modalias
    find /sys/devices -name modalias -exec sort -u {} + |
      while read -r _mod || [ "$_mod" ]; do
        # Skip unneeded modules and skip modules which depends on
        # them as well.
        case $(modprobe -S "$kernel" -D "$_mod") in
        *wmi*|*gpu*|*net*) continue ;;
        esac 2>/dev/null

        copy_module "$_mod"
      done

    if [ "$root_type" ]; then
      copy_module "$root_type"
    else
      while read -r _ _dir _type _; do
        [ "$_dir" = / ] && break
      done < /proc/mounts || panic "failed to autodetect root fs module"

      copy_module "$_type"
    fi

  else
    print "copying all modules"

    find \
      "$moddir/$kernel/kernel/fs"                   \
      "$moddir/$kernel/kernel/lib"                  \
      "$moddir/$kernel/kernel/arch"                 \
      "$moddir/$kernel/kernel/crypto"               \
      "$moddir/$kernel/kernel/drivers/md"           \
      "$moddir/$kernel/kernel/drivers/ata"          \
      "$moddir/$kernel/kernel/drivers/scsi"         \
      "$moddir/$kernel/kernel/drivers/block"        \
      "$moddir/$kernel/kernel/drivers/virtio"       \
      "$moddir/$kernel/kernel/drivers/usb/host"     \
      "$moddir/$kernel/kernel/drivers/usb/storage"  \
      -type f 2>/dev/null |
        while read -r _mod || [ "$_mod" ]; do
          # Intentional.
          # shellcheck disable=2295
          copy_file "$_mod" "/lib/modules/${_mod#$moddir}" 644 0
        done
  fi

  copy_binary modprobe

  copy_file "$moddir/$kernel/modules.order" \
    "/lib/modules/$kernel/modules.order" 644 0

  copy_file "$moddir/$kernel/modules.builtin" \
    "/lib/modules/$kernel/modules.builtin" 644 0

  copy_file "$moddir/$kernel/modules.builtin.modinfo" \
    "/lib/modules/$kernel/modules.builtin.modinfo" 644 0

  print "copying local /etc/modprobe.d config files"
  find /etc/modprobe.d/ -type f -name "*.conf" |
    while read -r _cfg; do
      copy_file "$_cfg" "$_cfg" 0644
    done

  depmod -b "$tmpdir" "$kernel"
}

make_initramfs() (
  print "generating initramfs image"

  [ "$force" != 1 ] && [ -e "$output" ] &&
    panic "initramfs image already exist"

  cd "$tmpdir"
  find . | cpio -oH newc 2>/dev/null | ${compress:-cat} >"$output" ||
    panic "failed to generate initramfs image"

  print "done! check out $output" "\033[1;32m>>\033[m"
)

# Exit if command fails and disable globbing.
set -ef

parse_options "$@"
prepare_initramfs

for _hook in $hooks; do
  copy_hook "$_hook"
done

copy_modules
make_initramfs

# vim:sw=2:ts=2:sts=2:et:cc=72:tw=70
# End of file.
